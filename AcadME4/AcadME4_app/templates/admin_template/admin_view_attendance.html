{% extends 'admin_template/base_template.html' %}

{% block custom_css %}
<style>
    .attendance_container {
        display: flex;
        flex-wrap: wrap;
        justify-content: space-around;
        gap: 15px;
        margin-top: 20px;
    }

    .attendance_div {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-wrap: nowrap;
        min-width: 220px; /* Ensures it doesnâ€™t break unnecessarily */
        padding: 10px 15px;
        border-radius: 10px;
        box-shadow: 1px 1px 3px grey;
        background: #f0f0f0;
        border: 1px solid #ccc;
        color: #000;
        font-weight: bold;
        text-align: center;
        white-space: nowrap; /* Ensures name and attendance stay on the same line */
    }
</style>
{% endblock custom_css %}

{% block page_title %}
Monthly Attendance Report
{% endblock page_title %}

{% block main_content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">View Monthly Attendance</h3>
                    </div>

                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Subject</label>
                                    <select class="form-control" name="subject" id="subject">
                                        {% for subject in subjects %}
                                        <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Session Year</label>
                                    <select class="form-control" name="session_year_id" id="session_year_id">
                                        {% for session_year in session_year_id %}
                                        <option value="{{ session_year.id }}">{{ session_year.session_start_year }} to {{ session_year.session_end_year }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Select Month</label>
                                    <input type="month" class="form-control" id="attendance_month">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="button" class="btn btn-primary btn-block" id="fetch_attendance">Fetch Attendance</button>
                        </div>

                        <div class="form-group">
                            <div class="alert alert-danger" id="error_attendance" style="display:none"></div>
                        </div>
                    </div>

                    <div class="card-footer">
                        <div id="student_data" class="attendance_container"></div> <!-- Flexbox container -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
{% endblock main_content %}

{% block custom_js %}
<script>
    $(document).ready(function () {
        console.log("jQuery Loaded!");

        $("#fetch_attendance").click(function () {
            console.log("Fetch Attendance Button Clicked!");

            var subject = $("#subject").val();
            var session_year = $("#session_year_id").val();
            var selected_month = $("#attendance_month").val();

            if (!selected_month) {
                alert("Please select a month!");
                return;
            }

            var csrftoken = getCookie('csrftoken'); // CSRF token function

            $.ajax({
                url: '{% url "admin_get_monthly_attendance" %}',
                type: 'POST',
                data: {
                    subject: subject,
                    session_year_id: session_year,
                    month: selected_month
                },
                headers: {
                    "X-CSRFToken": csrftoken
                },
                success: function (response) {
                    console.log("Response Data:", response);
                    if (response.error) {
                        $("#error_attendance").html(response.error).show();
                        return;
                    }

                    var div_data = "";
                    response.forEach(function (student) {
                        div_data += `<div class='attendance_div'>${student.name} | Attended: ${student.attended_classes}/${student.total_classes}</div>`;
                    });

                    $("#student_data").html(div_data);
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", xhr.responseText);
                    alert("Error fetching attendance. Check the console for details.");
                }
            });
        });

        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock custom_js %}