{% extends 'admin_template/base_template.html' %}

{% block custom_css %}
<style>
    .attendance_table {
        width: 100%;
        margin-top: 20px;
        border-collapse: collapse;
    }

    .attendance_table th, .attendance_table td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: center;
    }

    .attendance_table th {
        background-color: #007bff;
        color: white;
    }
</style>
{% endblock custom_css %}

{% block page_title %}
Monthly Attendance Report
{% endblock page_title %}

{% block main_content %}
<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">View Monthly Attendance</h3>
                    </div>

                    <div class="card-body">
                        <div class="row">
                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Subject</label>
                                    <select class="form-control" name="subject" id="subject">
                                        {% for subject in subjects %}
                                        <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Session Year</label>
                                    <select class="form-control" name="session_year_id" id="session_year_id">
                                        {% for session_year in session_year_id %}
                                        <option value="{{ session_year.id }}">{{ session_year.session_start_year }} to {{ session_year.session_end_year }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>

                            <div class="col-lg-4">
                                <div class="form-group">
                                    <label>Select Month</label>
                                    <input type="month" class="form-control" id="attendance_month">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <button type="button" class="btn btn-primary btn-block" id="fetch_attendance">Fetch Attendance</button>
                        </div>

                        <div class="form-group">
                            <div class="alert alert-danger" id="error_attendance" style="display:none"></div>
                        </div>
                    </div>

                    <div class="card-footer">
                        <!-- ✅ Attendance Table -->
                        <div class="table-responsive">
                            <table class="table attendance_table" id="attendanceTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Student Name</th>
                                        <th>Attended Classes</th>
                                        <th>Total Classes</th>
                                        <th>Attendance Percentage</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                </div>
            </div>
        </div>
    </div>
</section>
{% endblock main_content %}

{% block custom_js %}
<script>
    $(document).ready(function () {
        console.log("jQuery Loaded!");

        $("#fetch_attendance").click(function () {
            console.log("Fetch Attendance Button Clicked!");

            var subject = $("#subject").val();
            var session_year = $("#session_year_id").val();
            var selected_month = $("#attendance_month").val();

            if (!selected_month) {
                console.log("⚠ Please select a month!");
                return;
            }

            var csrftoken = getCookie('csrftoken'); // CSRF token function

            $.ajax({
                url: '{% url "admin_get_monthly_attendance" %}',
                type: 'POST',
                data: {
                    subject: subject,
                    session_year_id: session_year,
                    month: selected_month
                },
                headers: {
                    "X-CSRFToken": csrftoken
                },
                success: function (response) {
                    console.log("Response Data:", response);
                    if (response.error) {
                        $("#error_attendance").html(response.error).show();
                        return;
                    }

                    var table_data = "";
                    response.forEach(function (student) {
                        let percentage = ((student.attended_classes / student.total_classes) * 100).toFixed(2);
                        table_data += `<tr>
                            <td>${student.name}</td>
                            <td>${student.attended_classes}</td>
                            <td>${student.total_classes}</td>
                            <td>${percentage}%</td>
                        </tr>`;
                    });

                    $("#attendanceTableBody").html(table_data);
                    $("#attendanceTable").show();
                },
                error: function (xhr, status, error) {
                    console.error("AJAX Error:", xhr.responseText);
                }
            });
        });

        // Function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                let cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    let cookie = cookies[i].trim();
                    if (cookie.startsWith(name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    });
</script>
{% endblock custom_js %}