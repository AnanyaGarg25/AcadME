{% extends 'student_template/base_template.html' %}
{% block page_title %}
View Attendance
{% endblock page_title %}
{% block main_content %}

<section class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-md-12">
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">View Attendance</h3>
                    </div>

                    <div class="card-body">
                        {% csrf_token %}
                        <div class="form-group">
                            <label>Subject</label>
                            <select class="form-control" name="subject" id="subject">
                                {% for subject in subjects %}
                                <option value="{{ subject.id }}">{{ subject.subject_name }}</option>
                                {% endfor %}
                            </select>
                        </div>

                        <!-- Month Picker -->
                        <div class="form-group">
                            <label>Select Month</label>
                            <input type="month" id="monthPicker" class="form-control">
                        </div>

                        <div class="form-group">
                            <button type="button" class="btn btn-primary btn-block" id="viewAttendanceBtn">View Attendance</button>
                        </div>

                        <!-- ‚úÖ Attendance Table -->
                        <div class="table-responsive">
                            <table class="table table-bordered" id="attendanceTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Date</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="attendanceTableBody">
                                    <!-- Data will be inserted here -->
                                </tbody>
                            </table>
                        </div>

                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<script>
document.addEventListener("DOMContentLoaded", function () {
    let attendanceBtn = document.getElementById("viewAttendanceBtn");
    let attendanceTable = document.getElementById("attendanceTable");
    let attendanceTableBody = document.getElementById("attendanceTableBody");

    attendanceBtn.addEventListener("click", function () {
        console.log("üéØ View Attendance clicked!");
        loadAttendance();
    });

    function loadAttendance() {
        let subjectId = document.getElementById('subject').value;
        let monthYear = document.getElementById('monthPicker').value;

        if (!subjectId || !monthYear) {
            console.log("‚ö† Please select a subject and month!");
            return;
        }

        console.log(`üìå Fetching data for Subject: ${subjectId}, Month: ${monthYear}`);

        fetch(`/get_attendance_data/?subject=${subjectId}&month=${monthYear}`)
            .then(response => response.json())
            .then(data => {
                console.log("üìä Attendance Data:", data);

                attendanceTableBody.innerHTML = ""; // Clear previous data

                if (data.length === 0) {
                    console.log("‚ö† No attendance records found for this month.");
                    attendanceTable.style.display = "none";
                    return;
                }

                data.forEach(entry => {
                    let row = `<tr>
                        <td>${entry.date}</td>
                        <td>${entry.status}</td>
                    </tr>`;
                    attendanceTableBody.innerHTML += row;
                });

                attendanceTable.style.display = "table";
            })
            .catch(error => {
                console.error("‚ùå Error fetching attendance:", error);
            });
    }
});
</script>

{% endblock main_content %}